<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèá Gosen TurfFilter</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js' defer></script>
    
    <!-- CSS int√©gr√© pour le style de l'application -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

        :root {
            --primary-color: #00C6FF; /* Neon Blue */
            --secondary-color: #FFFF00; /* Neon Yellow */
            --background-color: #0d0d0d; /* Near Black */
            --card-bg-color: #1a1a1a; /* Dark Gray */
            --text-color: #f0f0f0; /* Light Gray */
            --light-gray: #333333; /* Darker Gray */
            --success-color: #39FF14; /* Neon Green */
            --danger-color: #FF007F; /* Neon Pink */
            --border-radius: 12px;
            --box-shadow: 0 0 15px rgba(0, 198, 255, 0.5), 0 0 5px rgba(255, 255, 0, 0.5);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            color: var(--primary-color);
            font-size: 2.8rem;
            font-weight: 700;
            text-shadow: 0 0 5px var(--primary-color), 0 0 10px var(--primary-color);
        }

        .subtitle {
            font-size: 1.25rem;
            color: #aaa;
        }

        .card {
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            margin-bottom: 25px;
            transition: transform 0.2s ease-in-out;
            border: 1px solid var(--light-gray);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 25px rgba(0, 198, 255, 0.7), 0 0 10px rgba(255, 255, 0, 0.7);
        }

        h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-gray);
            font-size: 1.6rem;
            display: flex;
            align-items: center;
        }

        .about h2 button {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.6rem;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            text-align: left;
            padding: 0;
        }

        #about-content {
            transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out;
            overflow: hidden;
            max-height: 500px; /* Hauteur suffisante pour le contenu */
            opacity: 1;
        }

        #about-content.hidden {
            max-height: 0;
            opacity: 0;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 25px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ccc;
        }

        input[type="number"], textarea, select.form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #555;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #222;
            color: var(--text-color);
        }

        input[type="number"]:focus, textarea:focus, select.form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 198, 255, 0.3);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .total-combinaisons {
            margin-top: 20px;
            padding: 15px;
            background-color: #222;
            border-left: 5px solid var(--primary-color);
            font-weight: 600;
            text-align: center;
            border-radius: 0 8px 8px 0;
        }

        #parsed-groups .group {
            background-color: #2a2a2a;
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 8px;
            font-size: 0.95rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center; /* Vertically align items */
            justify-content: space-between; /* Pushes filter controls to the right */
            gap: 10px;
        }

        #parsed-groups .group-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-right: 10px;
        }

        .filter-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .filter-box {
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            padding: 20px;
            background-color: #222;
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .filter-header h3 {
            color: var(--primary-color);
            margin: 0;
            font-size: 1.2rem;
        }

        .filter-header .controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .remove-filter-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            font-weight: bold;
        }
        .remove-filter-btn:hover {
            color: var(--danger-color);
        }
        
        .rule-description {
            background-color: #222;
            border: 1px solid var(--secondary-color);
            color: var(--text-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            text-align: center;
            font-size: 0.9rem;
        }

        .filter-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .filter-controls.compact {
            flex-direction: row;
            align-items: center;
            gap: 8px;
        }
        .filter-controls.compact label {
            margin-bottom: 0;
            white-space: nowrap;
        }
        .filter-controls.compact input[type="number"] {
            width: 65px;
            padding: 8px;
        }
        .filter-controls.compact span {
            font-weight: bold;
        }

        .filter-controls.horizontal {
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: space-around;
        }
        .filter-controls.horizontal .form-group {
            flex: 1;
            min-width: 200px;
        }

        .sub-filter {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            background-color: #2a2a2a;
            border: 1px solid #444;
        }
        .sub-filter .compact label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .sub-filter .compact label input[type="number"] {
            width: 55px;
            padding: 4px;
            text-align: center;
            border-radius: 5px;
        }

        .group-filter-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
            background-color: #2a2a2a;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .group-filter-controls label {
            margin-bottom: 0;
            font-weight: 500;
            color: #ccc;
            white-space: nowrap;
        }

        .group-filter-controls input[type="number"] {
            width: 60px;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.9rem;
            text-align: center;
        }

        .info-icon {
            cursor: help;
            font-style: italic;
            font-weight: bold;
            color: var(--primary-color);
            margin-left: 5px;
            font-size: 0.9em;
        }

        .info-icon-general {
            margin-left: 10px; /* More margin to separate from title */
        }

        .switch.small-switch {
          width: 40px;
          height: 22px;
        }
        .switch.small-switch .slider:before {
          height: 16px;
          width: 16px;
          left: 3px;
          bottom: 3px;
        }
        .switch.small-switch input:checked + .slider:before {
          transform: translateX(18px);
        }

        /* --- Style pour le bouton switch --- */
        .switch {
          position: relative;
          display: inline-block;
          width: 50px;
          height: 28px;
        }
        .switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #555;
          transition: .4s;
          border-radius: 28px;
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 20px;
          width: 20px;
          left: 4px;
          bottom: 4px;
          background-color: #ccc;
          transition: .4s;
          border-radius: 50%;
        }
        input:checked + .slider {
          background-color: var(--success-color);
        }
        input:checked + .slider:before {
          transform: translateX(22px);
        }

        .results-summary {
            padding: 20px;
            background-color: #222;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .results-summary strong {
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .results-output {
            background-color: #111;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .combination-item {
            background: #2a2a2a;
            padding: 6px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 1px solid var(--primary-color);
            font-weight: 600;
            letter-spacing: 1px;
            color: var(--primary-color);
        }

        .loader-container {
            text-align: center;
            padding: 40px 0;
        }

        .loader {
            border: 8px solid #333;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #about-content ol, #about-content ul {
            padding-left: 20px;
            margin-top: 10px;
        }
        #about-content li {
            margin-bottom: 10px;
        }

        .add-filter-wrapper {
            margin-top: 20px;
            text-align: right;
        }

        .add-filter-btn {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px dashed var(--primary-color);
            border-radius: 8px;
            padding: 8px 15px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .add-filter-btn:hover {
            background-color: rgba(0, 198, 255, 0.1);
            border-style: solid;
            transform: translateY(-2px);
        }

        /* --- Synthesis Styles --- */
        .synthesis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .details-btn {
            background-color: #2a2a2a;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            font-style: italic;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .details-btn:hover {
            background-color: var(--primary-color);
            color: #111;
        }
        
        .synthesis-compact {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--secondary-color);
            padding: 15px;
            background-color: #222;
            border-left: 5px solid var(--secondary-color);
            border-radius: 8px;
            letter-spacing: 1.5px;
            text-shadow: 0 0 5px var(--secondary-color);
        }

        .synthesis-output-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            background-color: #111;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px; /* Ajout d un espace */
        }

        .synthesis-item {
            background: #2a2a2a;
            padding: 8px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            text-align: center;
            border: 1px solid #444;
        }

        .synthesis-item .horse-number {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .synthesis-item .horse-count {
            font-size: 0.85rem;
            color: #ccc;
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--card-bg-color);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 0 25px rgba(0, 198, 255, 0.5);
            width: 90%;
            max-width: 500px;
            position: relative;
            text-align: center;
            border: 1px solid var(--primary-color);
        }

        .modal-content h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .modal-content p {
            margin-bottom: 25px;
            color: #ccc;
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .modal-btn {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1rem;
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
        }

        .modal-btn.standard { border-color: var(--primary-color); color: var(--primary-color); }
        .modal-btn.standard:hover { background-color: var(--primary-color); color: #111; box-shadow: 0 0 15px var(--primary-color); }

        .modal-btn.advanced { border-color: var(--secondary-color); color: var(--secondary-color); }
        .modal-btn.advanced:hover { background-color: var(--secondary-color); color: #111; box-shadow: 0 0 15px var(--secondary-color); }

        .modal-btn.weight { border-color: var(--success-color); color: var(--success-color); }
        .modal-btn.weight:hover { background-color: var(--success-color); color: #111; box-shadow: 0 0 15px var(--success-color); }

        .modal-btn.numeric { border-color: #17a2b8; color: #17a2b8; }
        .modal-btn.numeric:hover { background-color: #17a2b8; color: #111; box-shadow: 0 0 15px #17a2b8; }

        .modal-btn.alternance { border-color: #6f42c1; color: #6f42c1; }
        .modal-btn.alternance:hover { background-color: #6f42c1; color: #111; box-shadow: 0 0 15px #6f42c1; }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2rem;
            color: #aaa;
            cursor: pointer;
        }
        .modal-close:hover {
            color: var(--danger-color);
        }

        @media (max-width: 900px) {
            .grid-container, .filter-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            h1 { font-size: 2.2rem; }
            .card { padding: 20px; }
        }

        /* --- Floating Action Button --- */
        .floating-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background-color: var(--primary-color);
            color: #111;
            padding: 12px 18px;
            border-radius: 50px;
            box-shadow: 0 0 15px var(--primary-color);
            font-size: 1.1rem;
            font-weight: 600;
            z-index: 999;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px; /* To avoid size changing too much */
            text-align: center;
        }

        .floating-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px var(--primary-color);
        }

        /* --- Tab Styles --- */
        .tab-container {
            width: 100%;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid var(--light-gray);
            margin-bottom: 20px;
        }
        .tab-btn {
            padding: 10px 20px;
            cursor: pointer;
            background: none;
            border: none;
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: #888;
            position: relative;
            top: 2px;
            border-bottom: 2px solid transparent;
        }
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-content {
            padding-top: 10px;
        }
    @keyframes logo-glow {
    0% { box-shadow: 0 0 5px rgba(0, 198, 255, 0.5); }
    50% { box-shadow: 0 0 20px rgba(0, 198, 255, 1); }
    100% { box-shadow: 0 0 5px rgba(0, 198, 255, 0.5); }
}

.logo-link img {
    border-radius: 50%;
    animation: logo-glow 2s infinite ease-in-out;
    transition: transform 0.1s ease;
}

.logo-link:active img {
    transform: scale(0.9);
    animation: none;
}
</style>
</head>
<body>

    <div class="container">
        <header>
            <a href="https://wa.me/241077045354?text=Bonjour,%20je%20souhaite%20souscrire%20√†%20un%20abonnement%20pour%20Gosen%20TurfFilter.%20Quelles%20sont%20les%20options%20pour%20un%20abonnement%20mensuel,%20annuel,%20ou%20√†%20vie%20?%20Je%20comprends%20que%20chaque%20licence%20est%20valable%20pour%20un%20seul%20appareil." target="_blank" class="logo-link"><img src="logo GM..webp" alt="Gosen TurfFilter Logo" style="width: 150px; height: auto; margin-bottom: 20px; border: 0;"></a>
            <h1>üèá Gosen TurfFilter</h1>
            <p class="subtitle">Application de filtrage de combinaisons hippiques</p>
<a href="abonnement.html" class="add-filter-btn" style="margin-top: 15px; text-decoration: none; display: inline-block;">S'abonner</a>
        </header>

        

        <div class="grid-container">
            <!-- Section de Configuration -->
            <div class="card config-card">
                <h2>‚öôÔ∏è 1. Configuration initiale</h2>
                <div class="form-group">
                    <label for="num-partants">Nombre de partants :</label>
                    <input type="number" id="num-partants" value="16" min="8" max="16">
                </div>
                <div class="form-group">
                    <label for="taille-combinaison">Taille de combinaison :</label>
                    <input type="number" id="taille-combinaison" value="6" min="2" max="7">
                </div>
                <div class="total-combinaisons" id="total-combinaisons-info"></div>
            </div>

            <!-- Section des Pronostics -->
            <div class="card pronostics-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>‚úçÔ∏è 2. Saisie des pronostics <button class="info-icon-general details-btn toggle-details-btn" data-target="#group-filter-explanation">i</button></h2>
                    <button id="upload-image-btn" class="add-filter-btn" style="margin-left: 15px; padding: 6px 12px; font-size: 0.8rem;">
                        üì∑ Extraire d'une image
                    </button>
                </div>
                <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
                <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;">
                <p id="ocr-status" style="text-align: center; margin-top: 10px; font-weight: 600; color: var(--primary-color); display: none;"></p>
                <p class="instructions">Entrez vos pronostics, un groupe par ligne.</p>
                <textarea id="pronostics" rows="6" placeholder="Ex: Mes favoris : 4, 7-10&#x0a;Outsiders : 1, 5, 12, 16&#x0a;Bases : 2, 8"></textarea>
                <div id="group-filter-explanation" style="display: none; margin-top: 15px;">
                    <p>Pour chaque groupe de pronostics que vous avez saisi, vous pouvez d√©finir une fourchette (minimum et maximum) de chevaux √† conserver dans les combinaisons finales. Si le nombre de chevaux de ce groupe dans une combinaison n'est pas compris entre votre Min et votre Max pour ce groupe, la combinaison est √©limin√©e.</p>
                    <p>Par exemple, si votre "Groupe 1" est [4, 7, 10] et que vous d√©finissez "Min: 1, Max: 2" pour ce groupe :</p>
                    <ul>
                        <li>Une combinaison comme [4, 1, 2, 3, 5, 6] (qui contient 1 cheval du Groupe 1) sera conserv√©e.</li>
                        <li>Une combinaison comme [4, 7, 1, 2, 3, 5] (qui contient 2 chevaux du Groupe 1) sera conserv√©e.</li>
                        <li>Une combinaison comme [4, 7, 10, 1, 2, 3] (qui contient 3 chevaux du Groupe 1) sera √©limin√©e car elle d√©passe le Max de 2.</li>
                    </ul>
                </div>
                <div id="parsed-groups"></div>
            </div>
        </div>

        <!-- Section de Synth√®se des Pronostics -->
        <div class="card synthesis-pronos-card">
            <h2>üìà Synth√®se des Pronostics</h2>
            
            <!-- Synth√®se par Citation -->
            <div id="citation-synthesis-section" style="margin-bottom: 20px;">
                <div class="synthesis-header">
                    <h4 style="color: var(--primary-color);">Par Citation</h4>
                    <button id="toggle-citation-details" class="details-btn toggle-details-btn" data-target="#citation-details-view">i</button>
                </div>
                <p style="font-size: 0.9rem; margin-bottom: 10px;">Classement par nombre d'apparitions dans les groupes.</p>
                <div id="citation-compact-view" class="synthesis-compact">En attente de pronostics...</div>
                <div id="citation-details-view" class="synthesis-output-grid" style="display: none;"></div>
            </div>

            <!-- Synth√®se par Position -->
            <div id="position-synthesis-section">
                <div class="synthesis-header">
                    <h4 style="color: var(--primary-color);">Par Position (Pond√©r√©)</h4>
                    <button id="toggle-position-details" class="details-btn toggle-details-btn" data-target="#position-details-view">i</button>
                </div>
                <p style="font-size: 0.9rem; margin-bottom: 10px;">Classement pond√©r√© par la position dans chaque groupe.</p>
                <div id="position-compact-view" class="synthesis-compact">En attente de pronostics...</div>
                <div id="position-details-view" class="synthesis-output-grid" style="display: none;"></div>
            </div>
        </div>

        <!-- Section des Crit√®res de Filtrage -->
        <div class="card filter-card">
            <h2>üîç 3. Crit√®res de filtrage</h2>
            <div class="filter-container" id="filter-container">
                <!-- Les filtres seront ajout√©s dynamiquement ici -->
            </div>
            <div class="add-filter-wrapper">
                <button id="add-extra-filter" class="add-filter-btn">+ Ajouter un filtre</button>
            </div>
        </div>


        <!-- Section des R√©sultats -->
        <div class="card results-card">
            <h2>üìä 4. R√©sultats du filtrage</h2>
            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="results-tab-content">R√©sultats</button>
                <button class="tab-btn" data-tab="backtest-tab-content">Backtest</button>
            </div>

            <div class="tab-content active" id="results-tab-content">
                <div class="results-summary" id="results-summary">
                    En attente de configuration...
                </div>
                <div class="loader-container" id="loader" style="display: none;">
                    <div class="loader"></div>
                    <p>Filtrage en cours, veuillez patienter...</p>
                </div>
                <div class="results-output" id="results-output"></div>
                <div id="synthesis-section" style="display: none; margin-top: 25px;">
                     <div class="synthesis-header">
                        <h4 style="color: var(--primary-color);">Synth√®se des Chevaux Filtr√©s</h4>
                        <button id="toggle-synthesis-details" class="details-btn toggle-details-btn" data-target="#synthesis-details-view">i</button>
                    </div>
                     <p style="font-size: 0.9rem; margin-bottom: 15px;">Classement des chevaux par fr√©quence d'apparition dans les combinaisons conserv√©es.</p>
                     <!-- Vue compacte (par d√©faut) -->
                    <div id="synthesis-compact-view" class="synthesis-compact"></div>
                    <!-- Vue d√©taill√©e (cach√©e par d√©faut) -->
                    <div id="synthesis-details-view" class="synthesis-output-grid" style="display: none;"></div>
                </div>
            </div>

            <div class="tab-content" id="backtest-tab-content" style="display: none;">
                <div id="backtest-section">
                    <p class="instructions" style="margin-bottom: 15px;">Entrez une combinaison d arrivee pour la comparer a votre selection filtree et vos criteres.</p>
                    <div class="form-group" style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="backtest-input" class="form-control" placeholder="Entrez l arrivee a tester (ex: 2, 7, 5, 1, 10)">
                        <button id="run-backtest-btn" class="add-filter-btn" style="padding: 12px 15px; white-space: nowrap;">Analyser</button>
                    </div>
                    <div id="backtest-results-container" style="display: none; margin-top: 20px;">
                        <pre id="backtest-results-output" style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; white-space: pre-wrap; word-wrap: break-word;"></pre>
                        <button id="save-backtest-btn" class="add-filter-btn" style="margin-top: 15px;">Sauvegarder l Analyse</button>
                    </div>
                </div>
            </div>
        </div>
    

    <!-- Section de Synth√®se de l Expert -->
    <div class="card expert-synthesis-card">
        <h2>üåü Synth√®se de l Expert</h2>
        <div id="expert-synthesis-section">
            <div class="synthesis-header">
                <h4 style="color: var(--primary-color);">Classement Global Pond√©r√©</h4>
                <button id="toggle-expert-details" class="details-btn toggle-details-btn" data-target="#expert-details-view">i</button>
            </div>
            <div id="expert-compact-view" class="synthesis-compact">En attente des r√©sultats du filtrage...</div>
            <div id="expert-details-view" style="display: none;">
                <p style="font-size: 0.9rem; margin-bottom: 15px; text-align: left;">
                    <b>G√©n√©ration de la synth√®se :</b><br>
                    Ce classement est obtenu en attribuant des points √† chaque cheval selon sa performance dans 3 cat√©gories : sa popularit√© dans vos pronostics (citation), sa position dans vos listes (pond√©ration), et sa fr√©quence dans les combinaisons finales. Un coefficient est appliqu√© pour donner plus de poids aux r√©sultats filtr√©s, consid√©r√©s comme plus pertinents. Le score final est la somme de ces points pond√©r√©s.
                </p>
                <div class="synthesis-output-grid"></div>
            </div>
        </div>
    </div>

    <!-- JavaScript int√©gr√© pour la logique de l application -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- S√âLECTION DES √âL√âMENTS DU DOM ---
            const numPartantsInput = document.getElementById('num-partants');
            const tailleCombinaisonInput = document.getElementById('taille-combinaison');
            const pronosticsTextarea = document.getElementById('pronostics');
            const totalCombinaisonsInfo = document.getElementById('total-combinaisons-info');
            const parsedGroupsDiv = document.getElementById('parsed-groups');
            const resultsSummaryDiv = document.getElementById('results-summary');
            const resultsOutputDiv = document.getElementById('results-output');
            const loader = document.getElementById('loader');
            
            const filterContainer = document.getElementById('filter-container');
            const uploadImageBtn = document.getElementById('upload-image-btn');
            const imageUploadInput = document.getElementById('image-upload-input');
            const cameraInput = document.getElementById('camera-input');
            const ocrStatus = document.getElementById('ocr-status');

            // --- BACKTEST ELEMENTS ---
            const backtestInput = document.getElementById('backtest-input');
            const runBacktestBtn = document.getElementById('run-backtest-btn');
            const backtestResultsContainer = document.getElementById('backtest-results-container');
            const backtestResultsOutput = document.getElementById('backtest-results-output');
            const saveBacktestBtn = document.getElementById('save-backtest-btn');

            // --- OCR Image Processing ---
            const imageSourceModal = document.getElementById('image-source-modal');
            const selectFileBtn = document.getElementById('select-file-btn');
            const takePhotoBtn = document.getElementById('take-photo-btn');
            const closeImageSourceModalBtn = document.getElementById('close-image-source-modal-btn');

            const handleImageFile = async (file) => {
                if (!file || typeof Tesseract === 'undefined') {
                    if (typeof Tesseract === 'undefined') {
                        console.error('Tesseract.js n\'est pas charg√©.');
                        ocrStatus.textContent = 'Erreur: La biblioth√®que d\'analyse n\'a pas pu √™tre charg√©e.';
                        ocrStatus.style.display = 'block';
                    }
                    return;
                }

                ocrStatus.textContent = 'Analyse de l\'image en cours...';
                ocrStatus.style.display = 'block';
                uploadImageBtn.disabled = true;

                try {
                    const { data: { text } } = await Tesseract.recognize(
                        file,
                        'fra', // Langue: Fran√ßais
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    ocrStatus.textContent = `Analyse en cours... ${Math.round(m.progress * 100)}%`;
                                }
                            }
                        }
                    );

                    pronosticsTextarea.value = text;
                    // D√©clenche la mise √† jour de l'application
                    handlePronosticsTextareaChange();

                    ocrStatus.textContent = 'Texte extrait avec succ√®s !';
                    setTimeout(() => { ocrStatus.style.display = 'none'; }, 3000);

                } catch (error) {
                    console.error('Erreur OCR:', error);
                    ocrStatus.textContent = 'Erreur lors de l\'analyse de l\'image.';
                    setTimeout(() => { ocrStatus.style.display = 'none'; }, 5000);
                } finally {
                    uploadImageBtn.disabled = false;
                    imageUploadInput.value = ''; // Permet de re-t√©l√©charger le m√™me fichier
                    cameraInput.value = '';
                }
            };

            if (uploadImageBtn) {
                uploadImageBtn.addEventListener('click', () => {
                    imageSourceModal.style.display = 'flex';
                });
            }

            if (closeImageSourceModalBtn) {
                closeImageSourceModalBtn.addEventListener('click', () => {
                    imageSourceModal.style.display = 'none';
                });
            }

            if (selectFileBtn) {
                selectFileBtn.addEventListener('click', () => {
                    imageUploadInput.click();
                    imageSourceModal.style.display = 'none';
                });
            }

            if (takePhotoBtn) {
                takePhotoBtn.addEventListener('click', () => {
                    cameraInput.click();
                    imageSourceModal.style.display = 'none';
                });
            }

            if (imageUploadInput) {
                imageUploadInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        handleImageFile(file);
                    }
                });
            }

            if (cameraInput) {
                cameraInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        handleImageFile(file);
                    }
                });
            }

            // --- MODAL ELEMENTS ---
            const addFilterButton = document.getElementById('add-extra-filter');
            const modal = document.getElementById('add-filter-modal');
            const closeModalButton = document.getElementById('close-modal-btn');
            const addStandardFilterBtn = document.getElementById('add-standard-filter-btn');
            const addAdvancedFilterBtn = document.getElementById('add-advanced-filter-btn');
            const addWeightFilterBtn = document.getElementById('add-weight-filter-btn');
            const addStatisticFilterBtn = document.getElementById('add-statistic-filter-btn');
            const addAlternanceFilterBtn = document.getElementById('add-alternance-filter-btn');

            // --- VARIABLES GLOBALES ---
            let worker;
            let debounceTimer;
            let filterIdCounter = 0;
            let synthesisData = { citation: [], position: [], results: [], expert: [] };
            let currentFilteredCombinations = []; // For backtesting

            // --- TEMPLATES DE FILTRE ---
            const standardFilterTemplate = (index) => `
                <div class="filter-box standard-filter" data-id="${index}">
                    <div class="filter-header"><h3>Expert 1</h3><div class="controls"><label class="switch"><input type="checkbox" class="filter-enable" checked><span class="slider"></span></label><button class="remove-filter-btn">&times;</button></div></div>
                    <p class="rule-description">"Garder si au moins <strong>X</strong> chevaux sont dans au moins <strong>Y</strong> groupes"</p>
                    <div class="filter-controls horizontal">
                        <div class="form-group compact"><label> Chevaux min (X):</label><input type="number" class="chevaux-min" value="1" min="1"></div>
                        <div class="form-group compact"><label>Groupes min (Y):</label><input type="number" class="groupes-min" value="1" min="1"></div>
                    </div>
                </div>`;

            const advancedFilterTemplate = (index) => `
                <div class="filter-box advanced-filter" data-id="${index}">
                    <div class="filter-header"><h3>Expert 2</h3><div class="controls"><label class="switch"><input type="checkbox" class="filter-enable" checked><span class="slider"></span></label><button class="remove-filter-btn">&times;</button></div></div>
                    <p class="rule-description">"Garder si au moins <strong>X</strong> chevaux <strong>communs</strong> existent dans au moins <strong>Y</strong> groupes"</p>
                    <div class="filter-controls horizontal">
                        <div class="form-group compact"><label>Chevaux communs min (X):</label><input type="number" class="chevaux-min" value="1" min="1"></div>
                        <div class="form-group compact"><label>Groupes min (Y):</label><input type="number" class="groupes-min" value="1" min="1"></div>
                    </div>
                </div>`;
            
            const weightFilterTemplate = (index) => `
                <div class="filter-box weight-filter" data-id="${index}">
                    <div class="filter-header"><h3>Poids</h3><div class="controls"><label class="switch"><input type="checkbox" class="filter-enable" checked><span class="slider"></span></label><button class="remove-filter-btn">&times;</button></div></div>
                    <div class="filter-controls">
                        <div class="form-group"><label>Source des poids :</label>
                            <select class="form-control weight-source">
                                <option value="default">Par D√©faut (N¬∞ du cheval)</option>
                                <option value="manual">S√©lection Manuelle</option>
                                <option value="citation">Synth√®se par Citation</option>
                                <option value="position">Synth√®se par Position</option>
                                <option value="results">Synth√®se des Chevaux Filtr√©s</option>
                                <option value="expert">Synth√®se de l Expert</option>
                            </select>
                        </div>
                        <div class="form-group manual-input-container" style="display:none;"><label>Liste manuelle des chevaux :</label><textarea class="manual-input" rows="3" placeholder="Saisir les num√©ros s√©par√©s par des espaces, virgules ou tirets..."></textarea></div>
                        <div class="form-group"><label>Poids Total Minimum :</label><input type="number" class="weight-min" value="21"></div>
                        <div class="form-group"><label>Poids Total Maximum :</label><input type="number" class="weight-max" value="81"></div>
                        <div class="weight-range-info" style="font-size: 0.85rem; text-align: center; color: #6c757d;"></div>
                    </div>
                </div>`;

            const statisticFilterTemplate = (index) => `
                <div class="filter-box statistic-filter" data-id="${index}">
                    <div class="filter-header"><h3>Statistiques</h3><div class="controls"><label class="switch"><input type="checkbox" class="filter-enable" checked><span class="slider"></span></label><button class="remove-filter-btn">&times;</button></div></div>
                    <div class="filter-controls">
                        <div class="sub-filter">
                            <label class="switch small-switch"><input type="checkbox" class="sub-filter-enable" data-subfilter="evenOdd" checked><span class="slider"></span></label>
                            <div class="compact">
                                <label>Nb de Pairs entre:</label>
                                <input type="number" class="even-min" value="0" min="0">
                                <span>et</span>
                                <input type="number" class="even-max" value="6" min="0">
                            </div>
                        </div>
                        <div class="sub-filter">
                            <label class="switch small-switch"><input type="checkbox" class="sub-filter-enable" data-subfilter="smallLarge" checked><span class="slider"></span></label>
                            <div class="compact">
                                <label>Nb. Petits (‚â§ <input type="number" class="limit" value="10" min="1">) entre:</label>
                                <input type="number" class="small-min" value="0" min="0">
                                <span>et</span>
                                <input type="number" class="small-max" value="6" min="0">
                            </div>
                        </div>
                        <div class="sub-filter">
                            <label class="switch small-switch"><input type="checkbox" class="sub-filter-enable" data-subfilter="consecutive" checked><span class="slider"></span></label>
                            <div class="compact">
                                <label>Suite de longueur entre:</label>
                                <input type="number" class="consecutive-min" value="0" min="0">
                                <span>et</span>
                                <input type="number" class="consecutive-max" value="7" min="0">
                            </div>
                        </div>
                    </div>
                </div>`;

            const alternanceFilterTemplate = (index) => `
                <div class="filter-box alternance-filter" data-id="${index}">
                    <div class="filter-header">
                        <h3>Alternance</h3>
                        <div class="controls">
                            <button type="button" class="details-btn info-btn" style="width: 24px; height: 24px; font-size: 0.9rem;" title="Expliquer le filtre d alternance">i</button>
                            <label class="switch"><input type="checkbox" class="filter-enable" checked><span class="slider"></span></label>
                            <button class="remove-filter-btn">&times;</button>
                        </div>
                    </div>
                    <p class="rule-description">"Garder si le nombre d alternances est entre <strong>Min</strong> et <strong>Max</strong>"</p>
                    <div class="filter-controls">
                        <div class="form-group"><label>Source de la liste ordonn√©e :</label>
                            <select class="form-control alternance-source">
                                <option value="default">Par D√©faut (N¬∞ du cheval)</option>
                                <option value="manual">S√©lection Manuelle</option>
                                <option value="citation">Synth√®se par Citation</option>
                                <option value="position">Synth√®se par Position</option>
                                <option value="results">Synth√®se des Chevaux Filtr√©s</option>
                                <option value="expert">Synth√®se de l Expert</option>
                            </select>
                        </div>
                        <div class="form-group manual-input-container" style="display:none;"><label>Liste manuelle des chevaux (ordre important) :</label><textarea class="manual-input" rows="3" placeholder="Saisir les num√©ros ordonn√©s, s√©par√©s par des espaces, virgules..."></textarea></div>
                        <div class="form-group"><label>Alternances Minimum :</label><input type="number" class="alternance-min" value="0" min="0"></div>
                        <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                            <label for="alternance-max-${index}">Alternances Maximum :</label>
                            <input type="number" id="alternance-max-${index}" class="alternance-max" value="5" min="0">
                        </div>
                    </div>
                </div>`;

            // --- FONCTIONS ---

            function combinationsCount(n, k) {
                if (k < 0 || k > n) return 0;
                if (k === 0 || k === n) return 1;
                if (k > n / 2) k = n - k;
                let res = 1;
                for (let i = 1; i <= k; i++) { res = res * (n - i + 1) / i; }
                return Math.round(res);
            }

            function updateTotalCombinaisonsInfo() {
                const n = parseInt(numPartantsInput.value);
                const k = parseInt(tailleCombinaisonInput.value);
                if (n < k || n < 8 || k < 2) { totalCombinaisonsInfo.innerHTML = "Param√®tres invalides."; return; }
                const count = combinationsCount(n, k);
                totalCombinaisonsInfo.innerHTML = `<strong>${count.toLocaleString('fr-FR')}</strong> combinaisons possibles`;

                const floatingCounter = document.getElementById('floating-counter');
                if (floatingCounter) {
                    floatingCounter.textContent = `${count.toLocaleString('fr-FR')}/${count.toLocaleString('fr-FR')}`;
                }
            }

            function calculateAlternances(combination, sourceArray) {
                if (sourceArray.length === 0) return 0;
                const combinationSet = new Set(combination.map(String));
                let alternances = 0;
                for (let i = 0; i < sourceArray.length - 1; i++) {
                    const currentIn = combinationSet.has(sourceArray[i]);
                    const nextIn = combinationSet.has(sourceArray[i+1]);
                    if (currentIn !== nextIn) {
                        alternances++;
                    }
                }
                return alternances;
            }

            let currentRawGroups = []; // Global variable to store raw groups

            function parsePronostics() {
                const text = pronosticsTextarea.value.trim();
                const lines = text.split('\n');
                currentRawGroups = lines.map(line => {
                    const parts = line.split(':');
                    let name = `Groupe ${lines.indexOf(line) + 1}`; // Default name
                    let horseNumbers = [];

                    if (parts.length > 1) {
                        name = parts[0].trim();
                        horseNumbers = parts[1].match(/\d+/g) ? [...new Set(parts[1].match(/\d+/g).map(Number))] : [];
                    } else {
                        // If no colon, treat the whole line as numbers
                        horseNumbers = line.match(/\d+/g) ? [...new Set(line.match(/\d+/g).map(Number))] : [];
                        if (horseNumbers.length > 0) {
                            name = `Groupe ${lines.indexOf(line) + 1}`; // Still use default if no explicit name
                        } else {
                            return null; // Skip empty lines
                        }
                    }
                    
                    if (horseNumbers.length === 0) return null; // Skip groups with no horses

                    return { name: name, horses: horseNumbers };
                }).filter(g => g !== null); // Filter out nulls (empty lines or lines with no horses)
                
                return currentRawGroups; // Return raw groups
            }

            function renderParsedGroups(rawGroups) {
                parsedGroupsDiv.innerHTML = rawGroups.map((group, index) => `
                    <div class="group">
                        <span class="group-title">${group.name}:</span>
                        [${group.horses.join(', ')}]
                        <div class="group-filter-controls">
                            <input type="number" class="group-min" value="0" min="0">
                            <span>-</span>
                            <input type="number" class="group-max" value="${group.horses.length}" min="0" max="${group.horses.length}">
                        </div>
                    </div>`).join('');

                // No longer attach event listeners here, handled by handlePronosticsTextareaChange
            }

            function updatePronosticsSyntheses(groups) { // 'groups' here will be currentRawGroups, which are now objects
                if (groups.length === 0) {
                    synthesisData.citation = [];
                    synthesisData.position = [];
                    renderPronosSynthesis('citation', [], 'fois');
                    renderPronosSynthesis('position', [], 'pts');
                    return;
                }
                const citationCounts = {};
                groups.forEach(group => { // Iterate over group objects
                    group.horses.forEach(horse => { // Access horses array
                        citationCounts[horse] = (citationCounts[horse] || 0) + 1;
                    });
                });
                synthesisData.citation = Object.entries(citationCounts).sort((a, b) => b[1] - a[1]);

                const positionScores = {};
                groups.forEach(group => { // Iterate over group objects
                    group.horses.forEach((horse, index) => { // Access horses array
                        positionScores[horse] = (positionScores[horse] || 0) + (group.horses.length - index); // Use group.horses.length
                    });
                });
                synthesisData.position = Object.entries(positionScores).sort((a, b) => b[1] - a[1]);

                renderPronosSynthesis('citation', synthesisData.citation, 'fois');
                renderPronosSynthesis('position', synthesisData.position, 'pts');
            }

            function renderPronosSynthesis(type, sortedData, unit) {
                const compactView = document.getElementById(`${type}-compact-view`);
                const detailsView = document.getElementById(`${type}-details-view`);
                if (!compactView || !detailsView) return;

                if(sortedData.length === 0) {
                    compactView.textContent = 'En attente de pronostics...';
                    detailsView.innerHTML = '';
                    return;
                }

                compactView.textContent = sortedData.map(([horse]) => horse).join(' - ');
                detailsView.innerHTML = sortedData.map(([horse, score]) => `<div class="synthesis-item"><div class="horse-number">${horse}</div><div class="horse-count">${score} ${unit}</div></div>`).join('');
            }

            function calculateAndRenderExpertSynthesis() {
                const { citation, position, results } = synthesisData;
                const expertCompactView = document.getElementById('expert-compact-view');
                const expertDetailsGrid = document.getElementById('expert-details-view').querySelector('.synthesis-output-grid');

                if (citation.length === 0 || position.length === 0 || results.length === 0) {
                    expertCompactView.textContent = 'En attente des r√©sultats du filtrage...';
                    expertDetailsGrid.innerHTML = '';
                    synthesisData.expert = [];
                    return;
                }

                const weights = { citation: 1.0, position: 1.5, results: 2.0 };
                const allHorses = [...new Set([...citation.map(h => h[0]), ...position.map(h => h[0]), ...results.map(h => h[0])])];
                
                const rankPoints = {
                    citation: new Map(citation.map(([h, _], i) => [h, citation.length - i])),
                    position: new Map(position.map(([h, _], i) => [h, position.length - i])),
                    results: new Map(results.map(([h, _], i) => [h, results.length - i]))
                };

                const finalScores = {};
                allHorses.forEach(horse => {
                    const pCitation = rankPoints.citation.get(horse) || 0;
                    const pPosition = rankPoints.position.get(horse) || 0;
                    const pResults = rankPoints.results.get(horse) || 0;
                    finalScores[horse] = (pCitation * weights.citation) + (pPosition * weights.position) + (pResults * weights.results);
                });

                synthesisData.expert = Object.entries(finalScores).sort((a, b) => b[1] - a[1]);

                expertCompactView.textContent = synthesisData.expert.map(([h]) => h).join(' - ');
                expertDetailsGrid.innerHTML = synthesisData.expert.map(([h, s]) => `<div class="synthesis-item"><div class="horse-number">${h}</div><div class="horse-count">${s.toFixed(1)} pts</div></div>`).join('');
            }

            function buildWeightMap(filterBox) {
                const source = filterBox.querySelector('.weight-source').value;
                const n = parseInt(numPartantsInput.value);
                const weightMap = new Map();
                let sortedWeights = [];

                // Initialize all with penalty
                for (let i = 1; i <= n; i++) { weightMap.set(i.toString(), n + 1); }

                switch(source) {
                    case 'default':
                        for(let i=1; i<=n; i++) { weightMap.set(i.toString(), i); }
                        sortedWeights = Array.from({length: n}, (_, i) => i + 1);
                        break;
                    case 'manual':
                        const manualInput = filterBox.querySelector('.manual-input').value;
                        const manualHorses = manualInput.match(/\d+/g) || [];
                        manualHorses.forEach((horse, index) => { weightMap.set(horse, index + 1); });
                        sortedWeights = Array.from({length: manualHorses.length}, (_, i) => i + 1);
                        break;
                    case 'citation':
                    case 'position':
                    case 'results':
                    case 'expert':
                        const synthesisList = synthesisData[source];
                        if (synthesisList.length > 0) {
                            synthesisList.forEach(([horse, _], index) => { weightMap.set(horse, index + 1); });
                            sortedWeights = Array.from({length: synthesisList.length}, (_, i) => i + 1);
                        } else {
                            sortedWeights = []; // No data, no weights
                        }
                        break;
                }
                return { weightMap, sortedWeights };
            }

            function updateAllWeightFiltersUI() {
                document.querySelectorAll('.weight-filter').forEach(box => {
                    const { sortedWeights } = buildWeightMap(box);
                    const k = parseInt(tailleCombinaisonInput.value);
                    const infoDiv = box.querySelector('.weight-range-info');
                    const source = box.querySelector('.weight-source').value;
                    const manualContainer = box.querySelector('.manual-input-container');
                    manualContainer.style.display = source === 'manual' ? 'block' : 'none';

                    if (sortedWeights.length < k) {
                        infoDiv.textContent = source === 'manual' || source === 'default' ? 'Pas assez de chevaux pour une combinaison.' : 'Donn√©es de synth√®se indisponibles.';
                        return;
                    }
                    const minWeight = sortedWeights.slice(0, k).reduce((a, b) => a + b, 0);
                    const maxWeight = sortedWeights.slice(-k).reduce((a, b) => a + b, 0);
                    infoDiv.textContent = `Poids th√©orique min: ${minWeight}, max: ${maxWeight}`;
                });
            }

            function updateAlternanceFiltersUI() {
                const k = parseInt(tailleCombinaisonInput.value);
                if (isNaN(k)) return;

                // The theoretical maximum number of alternations for a combination of size k is 2*k.
                // This occurs in a pattern like U,S,U,S...U,S where U=unselected, S=selected.
                const maxAlternances = 2 * k;

                document.querySelectorAll('.alternance-filter').forEach(box => {
                    const maxInput = box.querySelector('.alternance-max');
                    
                    maxInput.max = maxAlternances;
                    maxInput.value = maxAlternances; // Set the value directly
                });
            }

            function updateNumericFilterInputs() {
                const k = parseInt(tailleCombinaisonInput.value);
                if (isNaN(k) || k < 0) return;

                document.querySelectorAll('.statistic-filter').forEach(box => {
                    box.querySelectorAll('input[type="number"]').forEach(input => {
                        if (!input.classList.contains('limit')) { // Ne pas limiter le champ "limite"
                           input.max = k;
                           if (parseInt(input.value) > k) input.value = k; // Ajuster si la valeur est trop haute
                        }
                    });
                });
            }

            function triggerFilter() {
                const n = parseInt(numPartantsInput.value);
                const k = parseInt(tailleCombinaisonInput.value);
                // parsePronostics() now returns raw groups, but we need min/max from DOM
                // So, we'll get the raw groups and then augment them with min/max from the DOM
                const rawGroups = currentRawGroups; // Use the global variable updated by parsePronostics

                const groupsWithMinMax = Array.from(parsedGroupsDiv.children).map((groupDiv, index) => {
                    const minInput = groupDiv.querySelector('.group-min');
                    const maxInput = groupDiv.querySelector('.group-max');
                    return {
                        name: rawGroups[index].name, // Add name
                        horses: rawGroups[index].horses,
                        min: parseInt(minInput.value),
                        max: parseInt(maxInput.value)
                    };
                });

                const orFilters = Array.from(document.querySelectorAll('.standard-filter')).filter(b => b.querySelector('.filter-enable').checked).map(b => ({chevauxMin: parseInt(b.querySelector('.chevaux-min').value), groupesMin: parseInt(b.querySelector('.groupes-min').value) }));
                const andFilters = Array.from(document.querySelectorAll('.advanced-filter')).filter(b => b.querySelector('.filter-enable').checked).map(b => ({chevauxMin: parseInt(b.querySelector('.chevaux-min').value), groupesMin: parseInt(b.querySelector('.groupes-min').value) }));
                
                const weightFilters = Array.from(document.querySelectorAll('.weight-filter')).filter(b => b.querySelector('.filter-enable').checked).map(b => {
                    const { weightMap } = buildWeightMap(b);
                    const mapForWorker = {};
                    for (let [key, value] of weightMap) { mapForWorker[key] = value; }
                    return {
                        min: parseInt(b.querySelector('.weight-min').value),
                        max: parseInt(b.querySelector('.weight-max').value),
                        map: mapForWorker
                    };
                });

                const alternanceFilters = Array.from(document.querySelectorAll('.alternance-filter')).filter(b => b.querySelector('.filter-enable').checked).map(b => {
                    const source = b.querySelector('.alternance-source').value;
                    const n = parseInt(numPartantsInput.value);
                    let sourceArray = [];

                    switch(source) {
                        case 'default':
                            sourceArray = Array.from({length: n}, (_, i) => (i + 1).toString());
                            break;
                        case 'manual':
                            const manualInput = b.querySelector('.manual-input').value;
                            sourceArray = (manualInput.match(/\d+/g) || []);
                            break;
                        case 'citation':
                        case 'position':
                        case 'results':
                        case 'expert':
                            const synthesisList = synthesisData[source];
                            if (synthesisList.length > 0) {
                                sourceArray = synthesisList.map(([horse, _]) => horse);
                            }
                            break;
                    }

                    return {
                        min: parseInt(b.querySelector('.alternance-min').value),
                        max: parseInt(b.querySelector('.alternance-max').value),
                        source: sourceArray
                    };
                });

                let evenOddFilters = [];
                let smallLargeFilters = [];
                let consecutiveFilters = [];

                const statisticFilterBox = document.querySelector('.statistic-filter');
                if (statisticFilterBox && statisticFilterBox.querySelector('.filter-enable').checked) {
                    const evenOddSub = statisticFilterBox.querySelector('[data-subfilter="evenOdd"]');
                    if (evenOddSub && evenOddSub.checked) {
                        evenOddFilters.push({
                            min: parseInt(statisticFilterBox.querySelector('.even-min').value),
                            max: parseInt(statisticFilterBox.querySelector('.even-max').value)
                        });
                    }
                    const smallLargeSub = statisticFilterBox.querySelector('[data-subfilter="smallLarge"]');
                    if (smallLargeSub && smallLargeSub.checked) {
                        smallLargeFilters.push({
                            limit: parseInt(statisticFilterBox.querySelector('.limit').value),
                            min: parseInt(statisticFilterBox.querySelector('.small-min').value),
                            max: parseInt(statisticFilterBox.querySelector('.small-max').value)
                        });
                    }
                    const consecutiveSub = statisticFilterBox.querySelector('[data-subfilter="consecutive"]');
                    if (consecutiveSub && consecutiveSub.checked) {
                        consecutiveFilters.push({
                            min: parseInt(statisticFilterBox.querySelector('.consecutive-min').value),
                            max: parseInt(statisticFilterBox.querySelector('.consecutive-max').value)
                        });
                    }
                }

                if (n < k) { 
                    resultsSummaryDiv.innerHTML = "La taille de la combinaison ne peut √™tre sup√©rieure au nombre de partants."; 
                    resultsOutputDiv.innerHTML = ''; 
                    displayResults([], combinationsCount(n, k) || 0);
                    return; 
                }

                loader.style.display = 'block';
                resultsOutputDiv.innerHTML = '';
                resultsSummaryDiv.innerHTML = 'Filtrage en cours...';

                const floatingCounter = document.getElementById('floating-counter');
                if (floatingCounter) {
                    floatingCounter.textContent = '...';
                }

                if (worker) worker.terminate();

                const workerCode = `
                    function* combinationGenerator(arr, k) {
                        if (k === 0) { yield []; return; }
                        for (let i = 0; i <= arr.length - k; i++) { for (const c of combinationGenerator(arr.slice(i + 1), k - 1)) { yield [arr[i], ...c]; } }
                    }

                    function getLongestConsecutive(arr) {
                        if (arr.length < 2) return arr.length;
                        const sorted = [...arr].sort((a, b) => a - b);
                        let maxLen = 1;
                        let currentLen = 1;
                        for (let i = 1; i < sorted.length; i++) {
                            if (sorted[i] === sorted[i-1] + 1) {
                                currentLen++;
                            } else {
                                maxLen = Math.max(maxLen, currentLen);
                                currentLen = 1;
                            }
                        }
                        return Math.max(maxLen, currentLen);
                    }

                    function calculateAlternances(combination, sourceArray) {
                        if (sourceArray.length === 0) return 0;
                        const combinationSet = new Set(combination.map(String));
                        let alternances = 0;
                        for (let i = 0; i < sourceArray.length - 1; i++) {
                            const currentIn = combinationSet.has(sourceArray[i]);
                            const nextIn = combinationSet.has(sourceArray[i+1]);
                            if (currentIn !== nextIn) {
                                alternances++;
                            }
                        }
                        return alternances;
                    }

                    self.onmessage = function(e) {
                        const { n, k, groups, orFilters, andFilters, weightFilters, evenOddFilters, smallLargeFilters, consecutiveFilters, alternanceFilters } = e.data;
                        const partants = Array.from({ length: n }, (_, i) => i + 1);
                        const filteredCombinations = [];
                        
                        for (const combi of combinationGenerator(partants, k)) {
                            let isKept = true;

                            // New Group Min/Max Filter
                            if (isKept && groups.length > 0) {
                                for (const groupFilter of groups) {
                                    const horsesInGroup = combi.filter(horse => groupFilter.horses.includes(horse)).length;
                                    if (horsesInGroup < groupFilter.min || horsesInGroup > groupFilter.max) {
                                        isKept = false;
                                        break;
                                    }
                                }
                            }

                            // Numeric Filters
                            if (isKept && evenOddFilters.length > 0) {
                                const evenCount = combi.filter(num => num % 2 === 0).length;
                                for (const f of evenOddFilters) { 
                                    if (evenCount < f.min || evenCount > f.max) { isKept = false; break; }
                                }
                            }
                            if (isKept && smallLargeFilters.length > 0) {
                                for (const f of smallLargeFilters) {
                                    const smallCount = combi.filter(num => num <= f.limit).length;
                                    if (smallCount < f.min || smallCount > f.max) { isKept = false; break; }
                                }
                            }
                            if (isKept && consecutiveFilters.length > 0) {
                                const longest = getLongestConsecutive(combi);
                                for (const f of consecutiveFilters) {
                                    if (longest < f.min || longest > f.max) { isKept = false; break; }
                                }
                            }

                            // Weight Filter
                            if (isKept && weightFilters.length > 0) {
                                for(const f of weightFilters) {
                                    const totalWeight = combi.reduce((sum, horse) => sum + (f.map[horse] || 0), 0);
                                    if (totalWeight < f.min || totalWeight > f.max) { isKept = false; break; }
                                }
                            }

                            // Alternance Filter
                            if (isKept && alternanceFilters.length > 0) {
                                for (const f of alternanceFilters) {
                                    if (f.source.length > 0) {
                                        const alternanceCount = calculateAlternances(combi, f.source);
                                        if (alternanceCount < f.min || alternanceCount > f.max) {
                                            isKept = false;
                                            break;
                                        }
                                    }
                                }
                            }

                            // Group-based Filters (Standard and Advanced)
                            if (isKept && orFilters.length > 0 && groups.length > 0) {
                                for(const f of orFilters) { if (groups.filter(g => combi.filter(c => g.horses.includes(c)).length >= f.chevauxMin).length < f.groupesMin) { isKept = false; break; } }
                            }
                            if (isKept && andFilters.length > 0 && groups.length > 0) {
                                for(const f of andFilters) { const hgc = {}; combi.forEach(h => { hgc[h] = 0; groups.forEach(g => { if (g.horses.includes(h)) hgc[h]++; }); }); if (Object.keys(hgc).filter(ho => hgc[ho] >= f.groupesMin).length < f.chevauxMin) { isKept = false; break; } }
                            }

                            if (isKept) filteredCombinations.push(combi);
                        }
                        postMessage({ filteredCombinations });
                    };
                `;

                worker = new Worker(URL.createObjectURL(new Blob([workerCode], { type: 'application/javascript' })));
                worker.postMessage({ n, k, groups: groupsWithMinMax, orFilters, andFilters, weightFilters, evenOddFilters, smallLargeFilters, consecutiveFilters, alternanceFilters });

                worker.onmessage = function(e) {
                    const { filteredCombinations } = e.data;
                    displayResults(filteredCombinations, combinationsCount(n, k));
                    loader.style.display = 'none';
                    worker.terminate();
                };
            }

            function displayResults(filtered, total) {
                currentFilteredCombinations = filtered.map(c => c.sort((a, b) => a - b)); // Store sorted combinations for backtesting
                const filteredCount = filtered.length;
                const rate = total > 0 ? ((total - filteredCount) / total * 100).toFixed(2) : 0;
                resultsSummaryDiv.innerHTML = `<strong>${filteredCount.toLocaleString('fr-FR')}</strong> combinaisons conserv√©es sur <strong>${total.toLocaleString('fr-FR')}</strong> | Taux de filtrage : <strong style="color: ${rate > 90 ? 'var(--success-color)' : 'var(--danger-color)'}">${rate}%</strong>`;
                resultsOutputDiv.innerHTML = filtered.map(combi => `<span class="combination-item">${combi.join(' - ')}</span>`).join('');

                const floatingCounter = document.getElementById('floating-counter');
                if (floatingCounter) {
                    floatingCounter.textContent = `${filteredCount.toLocaleString('fr-FR')}/${total.toLocaleString('fr-FR')}`;
                }

                const synthesisSection = document.getElementById('synthesis-section');
                const compactView = document.getElementById('synthesis-compact-view');
                const detailsView = document.getElementById('synthesis-details-view');

                if (filteredCount === 0) {
                    synthesisSection.style.display = 'none';
                    synthesisData.results = [];
                } else {
                    const horseCounts = {};
                    filtered.flat().forEach(horse => { horseCounts[horse] = (horseCounts[horse] || 0) + 1; });
                    synthesisData.results = Object.entries(horseCounts).sort((a, b) => b[1] - a[1]);

                    compactView.textContent = synthesisData.results.map(([h]) => h).join(' - ');
                    detailsView.innerHTML = synthesisData.results.map(([h, c]) => `<div class="synthesis-item"><div class="horse-number">${h}</div><div class="horse-count">cit√© ${c} fois</div></div>`).join('');
                    synthesisSection.style.display = 'block';
                    detailsView.style.display = 'none';
                }
                calculateAndRenderExpertSynthesis();
                updateAllWeightFiltersUI();
            }

            function addFilter(type) {
                filterIdCounter++;
                let template;
                if (type === 'standard') template = standardFilterTemplate(filterIdCounter);
                else if (type === 'advanced') template = advancedFilterTemplate(filterIdCounter);
                else if (type === 'weight') template = weightFilterTemplate(filterIdCounter);
                else if (type === 'statistic') {
                    template = statisticFilterTemplate(filterIdCounter);
                    const btn = document.getElementById('add-statistic-filter-btn');
                    if(btn) btn.disabled = true;
                } 
                else if (type === 'alternance') {
                    template = alternanceFilterTemplate(filterIdCounter);
                }
                else return;

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = template;
                const newFilter = tempDiv.firstElementChild;
                filterContainer.appendChild(newFilter);

                newFilter.querySelector('.remove-filter-btn').addEventListener('click', () => {
                    newFilter.remove();
                    if (type === 'statistic') {
                        const btn = document.getElementById('add-statistic-filter-btn');
                        if(btn) btn.disabled = false;
                    }
                    handleInputChange();
                });

                if (type === 'alternance') {
                    const infoBtn = newFilter.querySelector('.info-btn');

                    const sourceSelect = newFilter.querySelector('.alternance-source');
                    if (sourceSelect) {
                        sourceSelect.addEventListener('change', () => {
                            const manualContainer = newFilter.querySelector('.manual-input-container');
                            manualContainer.style.display = sourceSelect.value === 'manual' ? 'block' : 'none';
                            handleInputChange(); // Trigger recalculation
                        });
                    }
                    if (infoBtn) {
                        infoBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            alert("Principe du Filtre d\'Alternance:\n\nCe filtre compte le nombre de 'sauts' entre un cheval s√©lectionn√© (S) et un non-s√©lectionn√© (N), en parcourant la liste ordonn√©e des partants.\n\nExemple : Pour la combinaison [1, 3, 5], les sauts sont :\n1(S) > 2(N) > 3(S) > 4(N) > 5(S).\nCela fait 4 alternances.\n\n---\n\nMax Intelligent :\nLe maximum d\'alternances pour une taille K est 2*K. Cette valeur est mise √† jour automatiquement.");
                        });
                    }
                }

                updateEventListeners();
                updateNumericFilterInputs();
                updateAlternanceFiltersUI(); // Also call it here to set the initial value
                modal.style.display = 'none';
            }

            function updateEventListeners() {
                // Event listener for pronosticsTextarea
                pronosticsTextarea.removeEventListener('input', handlePronosticsTextareaChange);
                pronosticsTextarea.addEventListener('input', handlePronosticsTextareaChange);

                // Event listeners for other inputs (excluding pronosticsTextarea)
                const otherInputs = document.querySelectorAll('input[type="number"]:not(#pronostics), .filter-enable, .weight-source, .manual-input');
                otherInputs.forEach(input => {
                    input.removeEventListener('input', handleInputChange); // Remove existing to prevent duplicates
                    input.addEventListener('input', handleInputChange);
                    if(input.classList.contains('weight-source')) {
                         input.removeEventListener('change', handleInputChange);
                         input.addEventListener('change', handleInputChange);
                    }
                });
            }

            function handleInputChange() {
                updateTotalCombinaisonsInfo();
                // parsePronostics() and renderParsedGroups() are now called by handlePronosticsTextareaChange
                updatePronosticsSyntheses(currentRawGroups); // Use global raw groups
                calculateAndRenderExpertSynthesis();
                updateAllWeightFiltersUI();
                updateNumericFilterInputs();
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(triggerFilter, 300);
            }

            function handlePronosticsTextareaChange() {
                const rawGroups = parsePronostics(); // Parse and update global currentRawGroups
                renderParsedGroups(rawGroups); // Render the groups with inputs

                // Attach event listeners to the newly created min/max inputs
                parsedGroupsDiv.querySelectorAll('.group-min, .group-max').forEach(input => {
                    input.removeEventListener('input', handleInputChange); // Remove existing to prevent duplicates
                    input.addEventListener('input', handleInputChange); // Now these directly trigger handleInputChange
                });

                handleInputChange(); // Trigger the main filter logic
            }

            // Specific listener for the combination size to update the Alternance Filter UI
            tailleCombinaisonInput.addEventListener('input', () => {
                updateAlternanceFiltersUI();
            });

            // --- BACKTEST LOGIC ---
            function runBacktest() {
                const arriveeInput = backtestInput.value;
                if (!arriveeInput.trim()) {
                    alert("Veuillez entrer une arriv√©e √† tester.");
                    return;
                }

                const arrivee = arriveeInput.match(/\d+/g).map(Number).sort((a, b) => a - b);
                if (arrivee.length === 0) {
                    alert("L'arriv√©e entr√©e est invalide.");
                    return;
                }

                // Find matching combinations
                const arriveeSet = new Set(arrivee);
                const matchingCombinations = currentFilteredCombinations.filter(c => {
                    const combinationSet = new Set(c);
                    for (const num of arriveeSet) {
                        if (!combinationSet.has(num)) return false;
                    }
                    return true;
                });
                const matchingCount = matchingCombinations.length;

                // --- Build Report ---
                let report = `--- RAPPORT DE BACKTEST ---
`;
                report += `Arriv√©e test√©e : ${arrivee.join(' - ')}
`;
                report += `Date du test : ${new Date().toLocaleString('fr-FR')}
`;
                
                // --- Presence Report ---
                report += `
--- STATUT DE PR√âSENCE ---
`;
                if (matchingCount > 0) {
                    report += `‚úÖ TROUV√âE : L'arriv√©e [${arrivee.join(', ')}] est contenue dans ${matchingCount} combinaison(s) de votre s√©lection.
`;
                } else {
                    report += `‚ùå ABSENTE : Aucun des num√©ros de l'arriv√©e [${arrivee.join(', ')}] n'a √©t√© trouv√© ensemble dans une m√™me combinaison de votre s√©lection.
`;
                }

                // --- Details of Matching Combinations ---
                if (matchingCount > 0) {
                    report += `
--- D√âTAILS DES COMBINAISONS TROUV√âES ---
`;

                    // Pre-fetch active filter settings to avoid recalculating in the loop
                    const activeWeightFilters = Array.from(document.querySelectorAll('.weight-filter:has(.filter-enable:checked)')).map(b => ({ id: b.dataset.id, map: buildWeightMap(b).weightMap }));
                    
                    const activeAlternanceFilters = Array.from(document.querySelectorAll('.alternance-filter:has(.filter-enable:checked)')).map(b => {
                        const source = b.querySelector('.alternance-source').value;
                        const n = parseInt(numPartantsInput.value);
                        let sourceArray = [];
                        switch(source) {
                            case 'default': sourceArray = Array.from({length: n}, (_, i) => (i + 1).toString()); break;
                            case 'manual': sourceArray = (b.querySelector('.manual-input').value.match(/\d+/g) || []); break;
                            default:
                                const synthesisList = synthesisData[source];
                                if (synthesisList && synthesisList.length > 0) sourceArray = synthesisList.map(([h]) => h);
                                break;
                        }
                        return { id: b.dataset.id, source: sourceArray };
                    });

                    matchingCombinations.forEach((combi, index) => {
                        report += `
#${index + 1} Combinaison : [${combi.join(', ')}]
`;
                        
                        // Even numbers
                        const evenCount = combi.filter(num => num % 2 === 0).length;
                        report += `  - Nb. Pairs : ${evenCount}
`;

                        // Weight
                        activeWeightFilters.forEach(wf => {
                            const totalWeight = combi.reduce((sum, horse) => sum + (wf.map.get(horse.toString()) || 0), 0);
                            report += `  - Poids (Filtre #${wf.id}) : ${totalWeight}
`;
                        });

                        // Alternance
                        activeAlternanceFilters.forEach(af => {
                            const alternanceCount = calculateAlternances(combi, af.source);
                            report += `  - Alternances (Filtre #${af.id}) : ${alternanceCount}
`;
                        });
                    });
                }

                // --- Group Analysis ---
                if (currentRawGroups.length > 0) {
                    report += `
--- ANALYSE DES GROUPES (pour l arrivee [${arrivee.join(', ')}] ---
`;
                    const groupAnalysis = {};
                    currentRawGroups.forEach(group => {
                        const intersection = group.horses.filter(h => arrivee.includes(h));
                        const count = intersection.length;
                        if (count > 0) groupAnalysis[count] = (groupAnalysis[count] || 0) + 1;
                    });

                    if (Object.keys(groupAnalysis).length > 0) {
                        for (let i = Math.max(...Object.keys(groupAnalysis)); i >= 1; i--) {
                            const groupsWithAtLeastI = Object.entries(groupAnalysis).filter(([count]) => parseInt(count) >= i).reduce((sum, [, groupCount]) => sum + groupCount, 0);
                            if (groupsWithAtLeastI > 0) report += `${groupsWithAtLeastI} groupe(s) contien(nen)t au moins ${i} num√©ro(s) de l arrivee.
`;
                        }
                    } else {
                        report += `Aucun des num√©ros de l arrivee n a √©t√© trouv√© dans vos groupes de pronostics.
`;
                    }
                }

                // --- Criteria Recall ---
                report += `
--- CRIT√àRES UTILIS√âS ---
`;
                report += `Configuration: ${numPartantsInput.value} partants, combinaisons de ${tailleCombinaisonInput.value}
`;
                document.querySelectorAll('.filter-box').forEach(box => {
                    const h3 = box.querySelector('h3');
                    if (!h3) return;
                    if (!box.querySelector('.filter-enable')?.checked) {
                        report += `
[D√âSACTIV√â] ${h3.textContent}
`;
                        return;
                    }
                    report += `
Filtre: ${h3.textContent}
`;
                    if (box.classList.contains('standard-filter') || box.classList.contains('advanced-filter')) {
                        report += `  -Chevaux min: ${box.querySelector('.chevaux-min').value}, Groupes min: ${box.querySelector('.groupes-min').value}
`;
                    } else if (box.classList.contains('weight-filter')) {
                        report += `  - Source: ${box.querySelector('.weight-source').selectedOptions[0].text}
`;
                        report += `  - Poids Min: ${box.querySelector('.weight-min').value}, Poids Max: ${box.querySelector('.weight-max').value}
`;
                    } else if (box.classList.contains('alternance-filter')) {
                        report += `  - Source: ${box.querySelector('.alternance-source').selectedOptions[0].text}
`;
                        report += `  - Alternances Min: ${box.querySelector('.alternance-min').value}, Max: ${box.querySelector('.alternance-max').value}
`;
                    } else if (box.classList.contains('statistic-filter')) {
                        if (box.querySelector('[data-subfilter="evenOdd"]').checked) report += `  - Pairs: entre ${box.querySelector('.even-min').value} et ${box.querySelector('.even-max').value}
`;
                        if (box.querySelector('[data-subfilter="smallLarge"]').checked) report += `  - Petits (‚â§${box.querySelector('.limit').value}): entre ${box.querySelector('.small-min').value} et ${box.querySelector('.small-max').value}
`;
                        if (box.querySelector('[data-subfilter="consecutive"]').checked) report += `  - Suite: entre ${box.querySelector('.consecutive-min').value} et ${box.querySelector('.consecutive-max').value}
`;
                    }
                });

                backtestResultsOutput.textContent = report;
                backtestResultsContainer.style.display = 'block';
            }

            function saveBacktestResult() {
                const textToSave = backtestResultsOutput.textContent;
                if (!textToSave) {
                    alert("Il n y a aucun r√©sultat de backtest √† sauvegarder.");
                    return;
                }
                const blob = new Blob([textToSave], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rapport-backtest-${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // --- GESTIONNAIRES D √âV√âNEMENTS ---
            // --- Tab Switching Logic ---
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.style.display = 'none');
                    
                    button.classList.add('active');
                    const activeTab = document.getElementById(button.dataset.tab);
                    if (activeTab) {
                        activeTab.style.display = 'block';
                    }
                });
            });

            runBacktestBtn.addEventListener('click', runBacktest);
            saveBacktestBtn.addEventListener('click', saveBacktestResult);
            
            addFilterButton.addEventListener('click', () => { modal.style.display = 'flex'; });
            closeModalButton.addEventListener('click', () => { modal.style.display = 'none'; });
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
            addStandardFilterBtn.addEventListener('click', () => addFilter('standard'));
            addAdvancedFilterBtn.addEventListener('click', () => addFilter('advanced'));
            addWeightFilterBtn.addEventListener('click', () => addFilter('weight'));
            addStatisticFilterBtn.addEventListener('click', () => addFilter('statistic'));
            addAlternanceFilterBtn.addEventListener('click', () => addFilter('alternance'));

            document.querySelectorAll('.toggle-details-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetSelector = e.currentTarget.dataset.target;
                    const detailsView = document.querySelector(targetSelector);
                    if (detailsView) {
                        const isHidden = detailsView.style.display === 'none';
                        detailsView.style.display = isHidden ? 'grid' : 'none';
                    }
                });
            });

            // --- INITIALISATION ---
            addFilter('standard'); // Ajoute un filtre standard par d√©faut
            addFilter('advanced'); // Ajoute un filtre avanc√© par d√©faut
            updateEventListeners();
            handleInputChange();
        });
    </script>

    <!-- Floating Action Button for Combinations -->
    <div id="floating-counter" class="floating-btn" title="Combinaisons restantes"></div>

    <!-- Modal for adding new filters -->
    <div id="add-filter-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Ajouter un nouveau filtre</h3>
            <p>Choisissez le type de filtre que vous souhaitez ajouter √† votre analyse.</p>
            <div class="modal-actions">
                <button id="add-standard-filter-btn" class="modal-btn standard">Expert 1</button>
                <button id="add-advanced-filter-btn" class="modal-btn advanced">Expert 2</button>
                <button id="add-weight-filter-btn" class="modal-btn weight">Poids</button>
                <button id="add-statistic-filter-btn" class="modal-btn numeric">Statistiques</button>
                <button id="add-alternance-filter-btn" class="modal-btn alternance">Alternance</button>
            </div>
            <button id="close-modal-btn" class="modal-close">&times;</button>
        </div>
    </div>

    <!-- Modal for image source selection -->
    <div id="image-source-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3>Source de l\'image</h3>
            <p>Choisissez si vous souhaitez t√©l√©verser un fichier ou prendre une nouvelle photo.</p>
            <div class="modal-actions">
                <button id="select-file-btn" class="modal-btn standard">Choisir un fichier</button>
                <button id="take-photo-btn" class="modal-btn advanced">Prendre une photo</button>
            </div>
            <button id="close-image-source-modal-btn" class="modal-close">&times;</button>
        </div>
    </div>
</body>
</html>
